<!--
加了这个玩意儿，导致获取 document.documentElement.clientWidth; document.documentElement.clientHeight; 有问题？
<!DOCTYPE html>
-->
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>save sun</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
</head>
<body>
<style>
    *{
        margin:0;
        padding:0;
    }
</style>
<canvas id="canvas"></canvas>
<script src="zepto.js"></script>
<script src="underscore1.8.js"></script>
<script src="plugin.js"></script>
<script>
    //创建TaskList;
    var TaskList = function() {this.list = [], this.timer = null};
    TaskList.tId = 0;
    TaskList.prototype.addTask = function (fn) {
        fn.tId = TaskList.tId++;
        if(typeof fn === "function")this.list.push(fn);
        return this;
    };
    TaskList.prototype.removeTask = function(fn) {
        var len = 0;
        while(len--){
            if(fn === this.list[len] || fn.tId === this.list[len].tId) {
                this.list.splice(len,1);
            };
        };
    };
    TaskList.prototype.run = function() {
        for(var i=0; i<this.list.length; i++ ){
            this.list[i]();
        }
    };
    TaskList.prototype.setInterval = function ( time ) {
        this.timer = setInterval(this.run.bind(this), time);
    };
    TaskList.prototype.clearInterval = function() {
        clearInterval( this.timer );
    };

    //计算运动的库
    /////////////////////////////////////////////////////////////////////////////
    //Cubic , Quart, Quint, Sine, Expo, Bounce , Back, Elastic, Circ, linear, Quad
    var Tween = {
        Linear: function(t,b,c,d){ return c*t/d + b; },
        Quad: {
            easeIn: function(t,b,c,d){
                return c*(t/=d)*t + b;
            },
            easeOut: function(t,b,c,d){
                return -c *(t/=d)*(t-2) + b;
            },
            easeInOut: function(t,b,c,d){
                if ((t/=d/2) < 1) return c/2*t*t + b;
                return -c/2 * ((--t)*(t-2) - 1) + b;
            }
        },
        Cubic: {
            easeIn: function(t,b,c,d){
                return c*(t/=d)*t*t + b;
            },
            easeOut: function(t,b,c,d){
                return c*((t=t/d-1)*t*t + 1) + b;
            },
            easeInOut: function(t,b,c,d){
                if ((t/=d/2) < 1) return c/2*t*t*t + b;
                return c/2*((t-=2)*t*t + 2) + b;
            }
        },
        Quart: {
            easeIn: function(t,b,c,d){
                return c*(t/=d)*t*t*t + b;
            },
            easeOut: function(t,b,c,d){
                return -c * ((t=t/d-1)*t*t*t - 1) + b;
            },
            easeInOut: function(t,b,c,d){
                if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
                return -c/2 * ((t-=2)*t*t*t - 2) + b;
            }
        },
        Quint: {
            easeIn: function(t,b,c,d){
                return c*(t/=d)*t*t*t*t + b;
            },
            easeOut: function(t,b,c,d){
                return c*((t=t/d-1)*t*t*t*t + 1) + b;
            },
            easeInOut: function(t,b,c,d){
                if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
                return c/2*((t-=2)*t*t*t*t + 2) + b;
            }
        },
        Sine: {
            easeIn: function(t,b,c,d){
                return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
            },
            easeOut: function(t,b,c,d){
                return c * Math.sin(t/d * (Math.PI/2)) + b;
            },
            easeInOut: function(t,b,c,d){
                return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
            }
        },
        Expo: {
            easeIn: function(t,b,c,d){
                return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
            },
            easeOut: function(t,b,c,d){
                return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
            },
            easeInOut: function(t,b,c,d){
                if (t==0) return b;
                if (t==d) return b+c;
                if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
                return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
            }
        },
        Circ: {
            easeIn: function(t,b,c,d){
                return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
            },
            easeOut: function(t,b,c,d){
                return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
            },
            easeInOut: function(t,b,c,d){
                if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
                return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
            }
        },
        Elastic: {
            easeIn: function(t,b,c,d,a,p){
                if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
                if (!a || a < Math.abs(c)) { a=c; var s=p/4; }
                else var s = p/(2*Math.PI) * Math.asin (c/a);
                return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
            },
            easeOut: function(t,b,c,d,a,p){
                if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
                if (!a || a < Math.abs(c)) { a=c; var s=p/4; }
                else var s = p/(2*Math.PI) * Math.asin (c/a);
                return (a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b);
            },
            easeInOut: function(t,b,c,d,a,p){
                if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
                if (!a || a < Math.abs(c)) { a=c; var s=p/4; }
                else var s = p/(2*Math.PI) * Math.asin (c/a);
                if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
                return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
            }
        },
        Back: {
            easeIn: function(t,b,c,d,s){
                if (s == undefined) s = 1.70158;
                return c*(t/=d)*t*((s+1)*t - s) + b;
            },
            easeOut: function(t,b,c,d,s){
                if (s == undefined) s = 1.70158;
                return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
            },
            easeInOut: function(t,b,c,d,s){
                if (s == undefined) s = 1.70158;
                if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
                return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
            }
        },
        Bounce: {
            easeIn: function(t,b,c,d){
                return c - Tween.Bounce.easeOut(d-t, 0, c, d) + b;
            },
            easeOut: function(t,b,c,d){
                if ((t/=d) < (1/2.75)) {
                    return c*(7.5625*t*t) + b;
                } else if (t < (2/2.75)) {
                    return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
                } else if (t < (2.5/2.75)) {
                    return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
                } else {
                    return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
                }
            },
            easeInOut: function(t,b,c,d){
                if (t < d/2) return Tween.Bounce.easeIn(t*2, 0, c, d) * .5 + b;
                else return Tween.Bounce.easeOut(t*2-d, 0, c, d) * .5 + c*.5 + b;
            }
        }
    }
</script>

<script>
    canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");

    var util = {
        isMobile : typeof document.ontouchstart == "object" ? true : false,
        loadImgs: function(arr) {
            for (var i = 0; i < arr.length; i++) {
                var img = new Image();
                img.onload = function () {
                    console.log(this.src);
                }
                img.src = arr[i];
            }
        }
    };

    var Ev = function( opt ) {
        this.canvas = opt.canvas || {};
        this.context = this.canvas&&this.canvas.getContext("2d") || opt.context || {};
    };
    Ev.prototype.draw = function() {
        this.context.beginPath();
        this.context.fillStyle = "#f5f5f5";
        this.context.rect(0, 0, this.canvas.width, this.canvas.height);
        this.context.fill();
    };

    //为行星添加改变阴影的方法, 用来继承;
    var Shadow = function() {
        this.shadow = 1;
        this.dir = 1;
    };
    Shadow.prototype.changeShadow = function() {
        if(this.dir===1) {
            this.shadow++ > 20 ? this.dir = -1 : 0;
        }else if(this.dir === -1){
            this.shadow-- <=0 ? this.dir = 1 : 0;
        };
        return this;
    };

    var Air = function( opt ) {
        this.canvas = opt.canvas || {};
        this.context = this.canvas&&this.canvas.getContext("2d") || opt.context || {};
        this.opera = new CommonControl;
        this.width = 10;
        this.height = 10;
        this.x = this.canvas.width/2-this.width/2;
        this.y = this.canvas.height-this.height;
        this.bindEv();
    };
    Air.prototype = new Shadow();
    Air.prototype.draw = function() {
        this.context.save();
        this.context.beginPath();
        this.context.fillStyle = "#9B59B6";
        this.changeShadow();
        this.context.shadowBlur =  this.shadow;
        this.context.shadowColor = "#9B59B6";
        this.context.arc(this.x ,this.y , this.width, 0, 360, false);
        //this.context.rect( this.x, this.y, this.width, this.height);
        this.context.fill();
        this.context.restore();
    };
    Air.prototype.bindEv = function() {
        this.opera.run(function() {
                this.x--;
                this.x = this.x<0 ? 0 : (this.x> this.canvas.width-this.width) ? this.canvas.width-this.width : this.x;
            }.bind(this),
            function() {
                this.y--;
                this.y = this.y<0 ? 0 : (this.y>this.canvas.height-this.height) ? this.canvas.height-this.height : this.y;
            }.bind(this),
            function() {
                this.x++;
                this.x = this.x<0 ? 0 : (this.x> this.canvas.width-this.width) ? this.canvas.width-this.width : this.x;
            }.bind(this),
            function() {
                this.y++;
                this.y = this.y<0 ? 0 : (this.y>this.canvas.height-this.height) ? this.canvas.height-this.height : this.y;
            }.bind(this),
            this.draw.bind(this));
    };

    var Star = function(opt) {
        this.canvas = opt.canvas || {};
        this.context = this.canvas&&this.canvas.getContext("2d") || opt.context || {};
        this.x = this.canvas.width/2;
        this.y = this.canvas.height/2;
        this.w = opt.w || 40;
        this.time = 1;
    };
    Star.prototype =  new Shadow;
    Star.prototype.draw = function () {
        this.time++;
        //保存之前的画布内容
        this.context.save();
        //重置0,0坐标点
        //this.context.translate(this.canvas.width/2, this.canvas.height/2);
        //设置旋转角度 ，角度转换为弧度角;
        //degrees*Math.PI/180
        //this.context.rotate(this.time*Math.PI/180);
        //画星球
        this.context.beginPath();
        //context.arc(x,y,r,sAngle,eAngle,counterclockwise);
        this.context.arc(this.x, this.w*2, this.w  ,0, 360, false);
        this.context.closePath();
        this.changeShadow();
        //添加阴影
        this.context.shadowBlur =  this.shadow;
        this.context.shadowColor = "#E67E22";
        //设置星球的填充颜色
        //新建渐变对象
        //context.createRadialGradient(x0,y0,r0,x1,y1,r1);
        this.context.color = this.context.createRadialGradient(this.x,this.y,0,this.x,this.y, this.w);
        //设置渐变效果
        this.context.color.addColorStop(0,"#D35400");//渐变开始点和颜色
        this.context.color.addColorStop(1,"#E67E22");//渐变结束点和颜色
        this.context.fillStyle = this.context.color;//将渐变对象复制给填充画笔
        //填充星球
        this.context.fill();
        //恢复之前保存的画布内容
        this.context.restore();
    };
    var Enemy = function(opt) {
        this.canvas = opt.canvas || {};
        this.context = this.canvas&&this.canvas.getContext("2d") || opt.context || {};
        this.h = opt.w || Math.floor( Math.random()*40 );
        this.w = opt.h || this.h;
        this.x = opt.x || Math.floor( Math.random()*this.canvas.width );
        this.y = opt.y || this.canvas.height;

        this.tween = (function() {
            return Tween.Linear;
            var tween = Tween[ ["Cubic" , "Quart", "Quint", "Sine", "Expo", "Bounce" , "Back", "Elastic", "Circ", "Linear", "Quad"][ Math.floor(Math.random()*11) ] ]
            return tween [ ["easeInOut","easeIn","easeOut"][ Math.floor(Math.random()*3) ] ];
        })();

        this.middle = this.canvas.width/2;
        //this.distance = Math.pow( Math.pow(this.middle-this.x,2) + Math.pow(this.y,2), 1/2);
        this.distanceX = this.middle;
        this.initX = this.x;
        this.initY = this.y;
        this.shape = ["rect", "arc"][Math.floor( Math.random()*2 )];
        this.targetY =  100;
        this.time = (new Date).valueOf();
    };
    Enemy.prototype = new Shadow();
    Enemy.prototype.run = function () {

    };
    Enemy.prototype.draw = function () {
        if( (new Date).valueOf()-this.time >8000) {
            this.x=this.middle;
        }else if(this.x<this.middle) {
            this.x = this.initX + this.tween((new Date).valueOf() - this.time, 0, this.distanceX - this.initX, 8000);
        }else if(this.x>this.middle) {
            this.x = this.initX - this.tween((new Date).valueOf()-this.time,0 ,this.initX - this.distanceX , 8000);
        };
        if( (new Date).valueOf()-this.time >8000) {
            this.y = this.targetY;
        }else{
            this.y = this.initY - this.tween((new Date).valueOf()-this.time,0 ,this.initY - this.targetY , 8000);
        };
        this.context.save();
        this.context.beginPath();
        //context.arc(x,y,r,sAngle,eAngle,counterclockwise);
        this.context.arc(this.x, this.y, this.w  ,0, 360, false);
        this.context.closePath();
        this.changeShadow();
        //添加阴影
        this.context.shadowBlur =  this.shadow;
        this.context.shadowColor = "#2C3E50";
        this.context.fillStyle = "#34495E";
        this.context.fill();
        this.context.restore();
        if(this.y < -this.h) {
            //重新新建这个实例
            var en = new Enemy({canvas : this.canvas});
            this.w = en.w,this.h = en.h, this.x = en.x, this.y = en.y;
            this.draw = en.draw;
        }
    };

    var taskList = new TaskList();

    $(function () {
        canvas.width = document.documentElement.clientWidth;
        canvas.height = document.documentElement.clientHeight;
        var ev = new Ev({canvas : canvas});
        var air = new Air({canvas : canvas});
        var star = new Star({canvas : canvas, w : 40});
        var ens = new Array(10);
        for(var i=0 ;i < ens.length; i++ ) {
            ens[i] = new Enemy({canvas : canvas});
        };
        taskList.addTask(function() {
            context.clearRect(0,0, canvas.width, canvas.height);
        }).addTask( ev.draw.bind(ev) ).addTask( air.draw.bind(air) ).addTask( star.draw.bind(star) ).addTask(function() {
            var len = ens.length;
            while(len--) {
                ens[len].draw.bind(ens[len])();
            };
        }).setInterval(30);
/*
        taskList.addTask(function() {
            context.clearRect(0,0, canvas.width, canvas.height);
        }).addTask(function() {
            var len = ens.length;
            while(len--) {
                ens[len].draw.bind(ens[len])();
            };
        }).setInterval(30);*/
    })
</script>
</body>
</html>